<!DOCTYPE html>
<html lang="th">

<head>
    <script src="./library/utils.js"></script>
    <link rel="stylesheet" href="https://phurich.github.io/phuthon/library/style.css">
    <html-header></html-header>
</head>

<body>
    <img src="./library/logo600px.png" alt="‡∏†‡∏π‡∏ò‡∏£‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà">
    <div id="dialog-overlay" class="dialog-overlay"></div>
    <div id="dialog-sky" class="setting-sky sky">
        <div class="satellite"></div>
    </div>
    <form id="getOrder" name="getOrder" method="post">
        <div class="flexRow">
            <label for="purchase" class="col-5">üíµ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠</label>
            <div class="col-7">
                <input id="purchase" name="purchase" style="width: 100%" pattern="^\d[\d\.\+\-]*" placeholder="40+50 ‡∏´‡∏£‡∏∑‡∏≠ 90" type="text" aria-describedby="purchaseHelpBlock">
                <span id="purchaseHelpBlock" class="form-text text-muted">üßô‚Äç‚ôÇÔ∏è ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏∏ 50+50 ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
            </div>
        </div>
        <div class="flexRow">
            <label for="delivery" class="col-5">üõµ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
            <div class="col-7">
                <input id="delivery" name="delivery" style="width: 100%" pattern="^\d[\d\.\+\-]*" placeholder="40 ‡∏´‡∏£‡∏∑‡∏≠ 40+20" type="text" aria-describedby="deliveryHelpBlock">
                <span id="deliveryHelpBlock" class="form-text text-muted">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û +10‡∏ø | üì¶ ‡∏¢‡∏Å‡∏•‡∏±‡∏á +20‡∏ø | üêò
                    ‡∏•‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ +20‡∏ø</span>
            </div>
        </div>
        <div class="flexRow">
            <label for="discount" class="col-5">üí∞‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
            <div class="col-7">
                <input id="discount" name="discount" style="width: 100%" pattern="^\d[\d\.\+\-]*" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" type="text" aria-describedby="discountHelpBlock" value="0">
                <span id="discountHelpBlock" class="form-text text-muted">üí∞ ‡πÄ‡∏û‡πá‡∏á‡∏ã‡∏≠‡∏¢ DIY -10‡∏ø | ‡πÉ‡∏ö‡∏ï‡∏≠‡∏á‡πÄ‡∏ö‡∏≠‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà -10%</span>
                <div class="form-check">
                    <input id="paid" name="paid" class="form-check-input" type="checkbox" value="Y">
                    <label class="form-check-label" style="padding-left: 15px;" for="paid">‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                </div>
            </div>
        </div>
        <div class="flexRow">
            <label for="tel" class="col-5">‚òéÔ∏è‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
            <div class="col-7">
                <input id="tel" name="tel" style="width: 100%" pattern="^\d{10}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö" type="text" value="" aria-describedby="telHelpBlock">
                <span id="telHelpBlock" class="form-text text-muted">ü§ñ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô '‡∏†‡∏π‡∏ò‡∏£‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå'
                    ‡πÑ‡∏î‡πâ</span>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="file-input-container">
                <label for="fileInput" id="fileLabel" class="button button-info button-lg">üì∏ ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (jpg)</label>
                <input type="file" id="fileInput" name="photo" accept="image/jpeg" capture="environment">
            </div>
        </div>
        <input type="hidden" id="rider" name="rider" value="">
        <input type="hidden" id="row" name="row" value="">
        <input type="hidden" id="imageURL" name="imageURL" value="">
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="photo" alt="Captured Photo" style="display:none;">
        <div class="row justify-content-center">
            <button name="formSubmit" type="submit" class="button button-primary button-lg">üì§‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div class="row justify-content-right">
            <button name="next" type="button" class="button button-warning button-lg" onclick="goToUrl();">üõµ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‚è©</button>
        </div>
    </form>
    <script>
        document.onreadystatechange = () => {
            if (document.readyState === "complete") {
                let queryString = decodeURIComponent(window.location.search);
                queryString = queryString.replace("?liff.state=", "");
                const params = new Proxy(new URLSearchParams(queryString), {
                    get: (searchParams, prop) => searchParams.get(prop),
                });
                document.getElementById("rider").value = params.rider;
                document.getElementById("row").value = params.row;
                document.getElementById("tel").value = params.tel;
                document.getElementById('getOrder').action = currentActionUrl;
            }
        };

        document.getElementById('fileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            //console.log('Original Image Size:', file.size);
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        const canvas = document.getElementById('canvas');
                        const context = canvas.getContext('2d', { willReadFrequently: true });
                        const maxWidth = 800;

                        let width = img.width;
                        let height = img.height;

                        // Resize the image while keeping the aspect ratio
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        context.drawImage(img, 0, 0, width, height);

                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        const brightness = 1.2; //Increase 20% brightness

                        for (let i = 0; i < data.length; i += 4) {
                            data[i] = data[i] * brightness;
                            data[i + 1] = data[i + 1] * brightness;
                            data[i + 2] = data[i + 2] * brightness;
                        }

                        context.putImageData(imageData, 0, 0);

                        const compressedImageData = canvas.toDataURL('image/jpeg', 0.4); // Adjust quality here
                        document.getElementById('photo').src = compressedImageData;
                        document.getElementById('photo').style.display = 'block';
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('getOrder').addEventListener('submit', handleFormSubmit);

        function validateForm() {
            // Get all input fields
            const purchase = document.getElementById('purchase').value;
            const delivery = document.getElementById('delivery').value;
            const discount = document.getElementById('discount').value;
            const tel = document.getElementById('tel').value;
            const fileInput = document.getElementById('fileInput');

            // Regular expressions for validation
            const purchasePattern = /^[+-]?(\d+(\.\d{1,2})?)([+-]\d+(\.\d+)?)*$/;
            const deliveryPattern = /^[+-]?(\d+(\.\d{1,2})?)([+-]\d+(\.\d+)?)*$/;
            const discountPattern = /^[+-]?(\d+(\.\d{1,2})?)([+-]\d+(\.\d+)?)*$/;
            const telPattern = /^(06|08|09)\d{8}$|^$/;

            // Validation messages
            let errorMessage = '';

            // Validate purchase field
            if (!purchasePattern.test(purchase)) {
                errorMessage += "‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n";
            }

            // Validate delivery field
            if (!deliveryPattern.test(delivery)) {
                errorMessage += "‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n";
            }

            // Validate discount field
            if (!discountPattern.test(discount)) {
                errorMessage += "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n";
            }

            // Validate telephone number
            if (!telPattern.test(tel)) {
                errorMessage += "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n";
            }

            // Validate file input (check if a file is selected)
            if (fileInput.files.length === 0) {
                errorMessage += "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠";
            }

            // Display error messages (if any)
            if (errorMessage) {
                swalShowError(errorMessage);
                return false; // Prevent form submission
            }

            return true; // Form is valid
        }

        async function handleFormSubmit(event) {
            event.preventDefault(); // Always prevent the default form submission

            if (!validateForm()) {
                document.getElementsByName('formSubmit')[0].disabled = false;
                return false;
            }

            document.getElementsByName('formSubmit')[0].disabled = true;
            document.getElementById('dialog-sky').style.display = 'block';
            document.getElementById('dialog-overlay').style.display = 'block';

            const success = await uploadToImgBB("Buy-");

            if (!success) {
                document.getElementById('dialog-sky').style.display = 'none';
                document.getElementById('dialog-overlay').style.display = 'none';
                swal({
                    title: '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
                    text: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤üòÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏≤‡∏á‡πÑ‡∏•‡∏ô‡πå",
                    icon: 'warning'
                }).then(
                    function () {
                        document.getElementById('getOrder').submit();
                    }
                )
            } else {
                document.getElementById('getOrder').submit();
            }
        }

        function goToUrl() {
            var taskParam = "rider=" + document.getElementById("rider").value + "&row=" + document.getElementById("row").value + "&tel=" + document.getElementById("tel").value;
            var url = "https://liff.line.me/1656261439-bwOVyD2R?" + taskParam;
            window.location.href = url;
        }
    </script>
</body>

</html>